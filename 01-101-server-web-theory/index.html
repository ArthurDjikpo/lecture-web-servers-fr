<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Cours serveurs web</title>

        <link rel="stylesheet" href="/css/bootstrap.min.css">
        <link rel="stylesheet" href="/css/font-awesome.min.css">
        <link rel="stylesheet" href="/css/highlight.dark.css">
        <link rel="stylesheet" href="/css/main.css">
    </head>
    <body>

        <header class="navbar navbar-default navbar-fixed-top">

            <a class="navbar-brand" href="/">
                Cours serveurs web
                <small class="hidden-xs hidden-sm">
                    Engineor
                </small>
            </a>

            
        </header>

        <main class="container-fluid">
            <div class="row">

                
                    <nav id="sidebar" class="col-sm-3 col-lg-2" role="navigation">

                        <ul class="nav nav-pills nav-stacked">
                                                            <li class="">
                                    <a href="/">
                                        Introduction
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/00-prerequisites">
                                        Prérequis
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/01-101-server-web-theory">
                                        Les bases
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/02-cgi">
                                        CGI
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/03-fastcgi">
                                        FastCGI
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/04-virtualhost">
                                        Virtualhost
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/05-php-apache-httpd">
                                        Apache httpd et PHP
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/06-php-multitenant">
                                        PHP multi utilisateur
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/07-php-multiple-versions">
                                        PHP plusieurs versions
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/08-php-scalability">
                                        PHP évolutif
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/09-security">
                                        Sécurité
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/10-databases">
                                        Bases de données
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="/11-web-hosting">
                                        Hébergement web
                                    </a>
                                </li>
                                                    </ul>

                    </nav>

                
                <section id="content" class="col-sm-offset-3 col-lg-offset-2 col-sm-9 col-lg-10">
                    <h1 id="thorie-des-serveurs-web">Théorie des serveurs web</h1>
<h2 id="dfinition">Définition</h2>
<p>Wikipedia FR :</p>
<blockquote>
<p>Un serveur web est spécifiquement un serveur multi-service utilisé pour publier des sites web sur Internet ou un intranet. L'expression « serveur Web » désigne également le logiciel utilisé sur le serveur pour exécuter les requêtes HTTP, le protocole de communication employé sur le World Wide Web.<br />
Un serveur web diffuse généralement des sites web, il peut contenir d'autres services liés comme l'envoi d'e-mails, du streaming, le transfert de fichiers par FTP, etc.  </p>
</blockquote>
<p>Dans notre contexte :</p>
<ul>
<li>Logiciel (on ne parle pas ici du serveur matériel)</li>
<li>Executer les requêtes http
<ul>
<li>servir un fichier statique</li>
<li>servir un fichier généré dynamiquement</li>
<li>interagir avec une base de donnée</li>
<li>interagir avec un système de fichier</li>
<li>servir un fichier dynamique de façon statique (cache http)</li>
</ul></li>
</ul>
<h2 id="role-de-base-du-serveur-http">Role (de base) du serveur http</h2>
<p><img src="01-101-server-web-theory/images/chrome-request.png" alt="" /></p>
<p>Le serveur http recoit une requête http qui lui vient du navigateur web (ou tout autre client http). Selon les demandes exprimées dans la requête (verbe, en-têtes, etc.), il génère une réponse qu'il renvoit au client.</p>
<p><img src="01-101-server-web-theory/images/http-request-simple.png" alt="" /></p>
<h3 id="1-requte-http">1. Requête http</h3>
<pre><code class="language-bash">curl -Lvso /dev/null http://localhost</code></pre>
<blockquote>
<p>GET / HTTP/1.1<br />
Host: localhost<br />
User-Agent: curl/7.54.0<br />
Accept: &ast;/&ast;  </p>
</blockquote>
<p>Ici, on utilise <code>curl</code> comme client http pour voir la requête envoyée. Pour débugger une requête http, il est aussi possible de passer par des services comme <a href="https://requestb.in/">RequestBin</a>.</p>
<p>Ce message demande une ressource spécifique via son url (la racine du site dans le cas présent). Toujours dans cet exemple précis, on constate que le client demande n'importe quel type de contenu, le serveur décidera donc ce qu'il doit servir basé sur sa valeur par défaut.</p>
<h3 id="2-rponse-http">2. Réponse http</h3>
<pre><code class="language-bash">curl -I http://localhost</code></pre>
<blockquote>
<p>HTTP/1.1 200 OK<br />
Date: Sat, 24 Feb 2018 10:50:40 GMT<br />
Server: Apache/2.4.29 (Unix)<br />
Last-Modified: Sat, 24 Feb 2018 10:37:38 GMT<br />
ETag: &quot;88-565f2dd9b8080&quot;<br />
Accept-Ranges: bytes<br />
Content-Length: 136<br />
Content-Type: text/html  </p>
</blockquote>
<pre><code class="language-bash">curl http://localhost</code></pre>
<pre><code class="language-html">&lt;!Doctype&gt;  
&lt;html&gt;  
    &lt;head&gt;
        &lt;title&gt;Hello World&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Hello World&lt;/h1&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>Les commandes ci-dessus nous montrent les en-têtes et le contenu de la réponse http renvoyée par le serveur http. Le <code>Content-Type</code> explique à notre client http comment interpréter la ressource, ici avec <code>curl</code> il traitera donc le contenu comme du texte qu'il affichera dans la console malgré le <code>Content-Type: text/html</code>. Un navigateur web interpreterait ce contenu pour afficher une page web.</p>
<h3 id="3-execution-de-la-requte">3. Execution de la requête</h3>
<p>Notre serveur est relativement simple pour le moment, et sert du contenu statique. L'exécution de la requête consiste donc à chercher sur le système de fichier si il existe un fichier ayant le nom donné dans l'url, en lire le contenu et le retourner avec les en-têtes requises.</p>
<h2 id="ports-par-dfaut-pour-les-requtes-web">Ports par défaut pour les requêtes web</h2>
<p>Les ports par défaut pour les requêtes web sont les suivantes :</p>
<ul>
<li>http : port 80</li>
<li>https : port 443</li>
</ul>
<p>Pour utiliser un port non standard, il suffit de mettre <code>:</code> et le numéro du port après le nom de domaine ou l'adresse IP.</p>
<h1 id="rappel--les-dns">Rappel : les DNS</h1>
<p>On accède à un serveur via son adresse IP (v4 ou v6)</p>
<p>Un nom de domaine a une <strong>zone</strong>, qui définit pour chaque entrée un type et une destination.</p>
<p><img src="01-101-server-web-theory/images/cloudflare.png" alt="" /></p>
<p>Pour la résolution de nom dans le cadre d'une requête http, seuls les champs <code>CNAME</code>, <code>A</code> et <code>AAAA</code> nous intéressent. Pour <code>A</code> et <code>AAAA</code> on associe un nom à une adresse. Pour le <code>CNAME</code>, on associe un nom à un autre nom, qui est lui même associé à une adresse.</p>
<p>Pour en savoir plus sur les DNS, vous pouvez vous réferrer au <a href="https://openclassrooms.com/courses/apprenez-le-fonctionnement-des-reseaux-tcp-ip/le-service-dns">cours d'OpenClassroom sur le fonctionnement des réseaux TCP/IP</a>.</p>
<p>Exemple de zone DNS (extrait de la zone de <code>scotlandphp.co.uk</code>) :</p>
<blockquote>
<p>;; CNAME Records<br />
webmail.scotlandphp.co.uk.      300    IN  CNAME  business.zoho.com.<br />
conference.scotlandphp.co.uk.   300    IN  CNAME  scotlandphp.github.io.<br />
www.slack.scotlandphp.co.uk.      300  IN  CNAME  slack.scotlandphp.co.uk.  </p>
<p>;; A Records (IPv4 addresses)<br />
2017.conference.scotlandphp.co.uk. 300 IN  A  149.202.172.54<br />
wallace.scotlandphp.co.uk.       300 IN  A  149.202.175.239  </p>
</blockquote>
<p>La résolution DNS la plus simple : <code>/etc/hosts</code> ou <code>C:\Windows\System32\drivers\etc</code> (par défaut).</p>
<pre><code>##
# Host Database
#
# localhost is used to configure the loopback interface
# when the system is booting.  Do not change this entry.
##
127.0.0.1   localhost keycloak.local
255.255.255.255 broadcasthost
::1             localhost </code></pre>
<p>Il est possible d'ajouter des lignes dans ce fichier pour résoudre arbitrairement un nom de domaine, notamment faire pointer un site sur la version de développement local.</p>
<h2 id="exemples-de-serveurs-http">Exemples de serveurs HTTP</h2>
<ul>
<li><a href="https://httpd.apache.org/">Apache2</a> (attention, Apache est une fondation, Apache2 est le nom courant du serveur http qui est en fait Apache http server project)</li>
<li><a href="https://nginx.org/">Nginx</a></li>
<li><a href="https://www.iis.net/">IIS</a></li>
<li><a href="https://caddyserver.com/">Caddy</a></li>
<li><a href="https://www.lighttpd.net/">Lighttp</a></li>
<li>...</li>
<li>n'importe quelle boucle infinie qui écoute un port, prends la requête et renvoit une réponse http</li>
</ul>
<h2 id="demo--exercice--dmarrer-apache-et-nginx">Demo / Exercice : démarrer Apache et Nginx</h2>
<h3 id="dmarrer-un-serveur-httpd-sans-configuration-spcifique">Démarrer un serveur httpd sans configuration spécifique</h3>
<pre><code>docker run --rm -p 80:80 httpd:latest</code></pre>
<p>Rendez-vous sur la page <a href="http://localhost"><a href="http://localhost">http://localhost</a></a> pour voir la page par défaut.</p>
<p>Eteignez ensuite le serveur en utilisant <code>Ctrl+C</code> dans votre ligne de commande dans laquelle le serveur a été lancé.</p>
<h3 id="dmarrer-un-serveur-nginx-sans-configuration-spcifique">Démarrer un serveur nginx sans configuration spécifique</h3>
<pre><code>docker run --rm -p 80:80 nginx:latest</code></pre>
<p>Rendez-vous sur la page <a href="http://localhost"><a href="http://localhost">http://localhost</a></a> pour voir la page par défaut.</p>
<p>Eteignez ensuite le serveur en utilisant <code>Ctrl+C</code> dans votre ligne de commande dans laquelle le serveur a été lancé.</p>
<h2 id="demo--exercice--servir-une-page-html-statique">Demo / Exercice : servir une page html statique</h2>
<p>L'exercice consiste à utiliser notre propre page html à la place de celle par défaut fournie par le serveur web.</p>
<p>Pour cela, étant donné que nous utilisons Docker, nous allons monter notre fichier dans le container créé pour écraser le fichier par défaut.</p>
<p>Dans une production, il faudrait écraser le fichier lors du build, et dans un environnement de développement dans Docker on remplacerait le fichier à la main.</p>
<h3 id="apache">Apache</h3>
<p>Dans le container Apache httpd, le dossier par défaut dans lequel on trouve le fichier <code>index.html</code> est <code>/usr/local/apache2/htdocs</code>.</p>
<pre><code class="language-bash">docker run --rm httpd ls -la /usr/local/apache2/htdocs</code></pre>
<p>Le fichier <code>index.html</code> que l'on veut utiliser contient le contenu suivant :</p>
<pre><code class="language-html">&lt;!Doctype&gt;  
&lt;html&gt;  
    &lt;head&gt;
        &lt;title&gt;Httpd : Hello World&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Httpd&lt;/h1&gt;
        &lt;h2&gt;Hello World&lt;/h2&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>Il est disponible dans le dossier <code>01-101-server-web-theory/demo2</code>, que nous allons donc monter pour remplacer <code>/usr/local/apache2/htdocs</code> dans le container.</p>
<pre><code class="language-bash">docker run --rm -p 80:80 -v $(pwd)/01-101-server-web-theory/demo2:/usr/local/apache2/htdocs httpd</code></pre>
<p>Ouvrez votre navigateur web sur l'url <a href="http://localhost"><a href="http://localhost">http://localhost</a></a> et vous devriez voir votre page.</p>
<h3 id="nginx">Nginx</h3>
<p>Dans le container Apache httpd, le dossier par défaut dans lequel on trouve le fichier <code>index.html</code> est <code>/usr/share/nginx/html</code>.</p>
<pre><code class="language-bash">docker run --rm nginx ls -la /usr/share/nginx/html</code></pre>
<p>Le fichier <code>index.html</code> que l'on veut utiliser contient le contenu suivant :</p>
<pre><code class="language-html">&lt;!Doctype&gt;  
&lt;html&gt;  
    &lt;head&gt;
        &lt;title&gt;Nginx : Hello World&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Nginx&lt;/h1&gt;
        &lt;h2&gt;Hello World&lt;/h2&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>Il est disponible dans le dossier <code>01-101-server-web-theory/demo3</code>, que nous allons donc monter pour remplacer <code>/usr/share/nginx/html</code> dans le container.</p>
<pre><code class="language-bash">docker run --rm -p 80:80 -v $(pwd)/01-101-server-web-theory/demo3:/usr/share/nginx/html:ro nginx</code></pre>
<p>Ouvrez votre navigateur web sur l'url <a href="http://localhost"><a href="http://localhost">http://localhost</a></a> et vous devriez voir votre page.</p>
<h2 id="documentroot">DocumentRoot</h2>
<p>Les dossiers dans lesquels nous avons fait les volumes Docker dans le chapitre précédent sont les <code>DocumentRoot</code> ou <code>root</code>, c'est à dire la racine du projet exposé par le serveur http.</p>
<p>Pour trouver ces chemins, il faut donc trouver la configuration du serveur web, dans laquelle ces racines sont indiquées.</p>
<h3 id="apache-1">Apache</h3>
<p>Dans le container httpd la configuration se trouve dans <code>/usr/local/apache2/conf/httpd.conf</code> d'après la documentation disponible sur le <a href="https://hub.docker.com/_/httpd/">Docker Hub de l'image httpd</a>.</p>
<pre><code class="language-bash">docker run httpd cat /usr/local/apache2/conf/httpd.conf</code></pre>
<p>Comme vous pouvez le constater la documentation d'Apache httpd est assez longue (et commentée). Parmis toutes les options et configurations, nous sommes uniquement intéressé par le <code>DocumentRoot</code> pour le moment.</p>
<p>Vous pouvez donc utiliser la commande suivante pour filtrer uniquement la valeur de la racine :</p>
<pre><code class="language-bash">docker run httpd cat /usr/local/apache2/conf/httpd.conf | grep DocumentRoot</code></pre>
<p>Il est donc maintenant possible de surcharger cette configuration avec notre configuration personnalisée.</p>
<p>Le contenu de la configuration du container a été copié dans le dossier <code>01-101-server-web-theory/demo4/config</code> grâce à la commande suivante :</p>
<pre><code class="language-bash">docker run httpd cat /usr/local/apache2/conf/httpd.conf &gt; 01-101-server-web-theory/demo4/config/httpd.conf</code></pre>
<p>Dans le fichier <code>01-101-server-web-theory/demo4/config/httpd.conf</code>, la valeur de <code>DocumentRoot</code> a été changé pour <code>/code</code> :</p>
<pre><code class="language-xml">DocumentRoot "/code"
&lt;Directory "/code"&gt;
    ...
&lt;/Directory&gt;    </code></pre>
<p>Notez que la valeur de l'instruction <code>Directory</code> suivante est aussi mise à jour, car elle défini les règles d'exécution pour ce répertoire.</p>
<p>Il reste ensuite à monter notre fichier html dans le dossier <code>/code</code> et notre configuration dans le dossier <code>/usr/local/apache2/conf/httpd.conf</code>.</p>
<pre><code>docker run -p 80:80 -v $(pwd)/01-101-server-web-theory/demo4/config/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro -v $(pwd)/01-101-server-web-theory/demo4/html:/code:ro httpd</code></pre>
<h3 id="nginx-1">Nginx</h3>
<p>Dans le container nginx la configuration se trouve dans <code>/etc/nginx/nginx.conf</code> d'après la documentation disponible sur le <a href="https://hub.docker.com/_/nginx/">Docker Hub de l'image nginx</a>.</p>
<pre><code class="language-bash">docker run nginx cat /etc/nginx/nginx.conf</code></pre>
<p>Comme vous pouvez le constater la documentation de nginx est assez courte (et non commentée). Parmis toutes les options et configurations, nous sommes uniquement intéressé par le <code>include /etc/nginx/conf.d/*.conf;</code> pour le moment. Celui-ci nous indique que les fichiers de configuration du dossier <code>conf.d</code> sont chargés automatiquement.</p>
<pre><code class="language-bash">docker run nginx ls /etc/nginx/conf.d</code></pre>
<blockquote>
<p>default.conf</p>
</blockquote>
<pre><code class="language-bash">docker run nginx cat /etc/nginx/conf.d/default.conf</code></pre>
<p>Comme vous pouvez le constater, ce fichier contient les lignes suivantes :</p>
<pre><code class="language-json">location = / {  
    root   /usr/share/nginx/html;  
}</code></pre>
<p>Il est donc maintenant possible de surcharger cette configuration avec notre configuration personnalisée.</p>
<p>Le contenu de la configuration du container a été copié dans le dossier <code>01-101-server-web-theory/demo5/config</code> grâce à la commande suivante :</p>
<pre><code class="language-bash">docker run nginx cat /etc/nginx/conf.d/default.conf &gt; 01-101-server-web-theory/demo5/config/default.conf</code></pre>
<p>Dans le fichier <code>01-101-server-web-theory/demo5/config/default.conf</code>, la valeur de <code>root</code> a été changé pour <code>/code</code> :</p>
<pre><code class="language-json">location = / {  
    root   /code;  
}   </code></pre>
<p>Il reste ensuite à monter notre fichier html dans le dossier <code>/code</code> et notre configuration dans le dossier <code>/etc/nginx/conf.d/</code>.</p>
<pre><code>docker run -p 80:80 -v $(pwd)/01-101-server-web-theory/demo5/config/default.conf:/etc/nginx/conf.d/default.conf:ro -v $(pwd)/01-101-server-web-theory/demo5/html:/code:ro nginx</code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>Dans ce chapitre, nous avons vu les bases des serveurs web, comment charger une page html statique et comment personnaliser la configuration de sorte à mettre notre projet à l'endroit qui nous convient sur la machine.</p>
<p>Si vous utilisez une solution pre-packagé (WAMP, MAMP, etc.), je vous invite à aller consulter les fichiers de configuration pour mieux comprendre comment ces ensembles applicatifs fonctionnent.</p>
<p>Le chapitre suivant couvrira une technique permettant de servir une page dynamique depuis un serveur http : l'<a href="02-cgi">utilisation des CGI</a>.</p>
                </section>

            </div>
        </main>

        <footer>
            <div class="container-fluid">
                <p class="text-muted">
                    website generated with <a href="http://couscous.io" title="Markdown website generator">Couscous</a>
                </p>
            </div>
        </footer>

        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <script src="//yastatic.net/highlightjs/8.2/highlight.min.js"></script>

        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');
                // Syntax highlighting
                hljs.initHighlightingOnLoad();
            });
        </script>

    </body>
</html>
